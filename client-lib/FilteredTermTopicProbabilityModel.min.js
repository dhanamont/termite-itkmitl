var FilteredTermTopicProbabilityModel=Backbone.Model.extend({defaults:{matrix:null,termIndex:null,topicIndex:null,sparseMatrix:null},url:"data/filtered-parameters.json",initialize:function(){this.termDistinctivenessMap=this.rowIndexMap=this.termOrderMap=this.termRankMap=this.parentModel=this.stateModel=null;this.termSaliencyList=[];this.selectedTopics={};this.visibleTopTerms={}}});FilteredTermTopicProbabilityModel.prototype.initModel=function(a,b){this.parentModel=a;this.stateModel=b};
FilteredTermTopicProbabilityModel.prototype.defaultSelection=function(){for(var a=this.parentModel.get("topicIndex"),b=0;b<a.length;b++)this.selectedTopics[b]=!1};
FilteredTermTopicProbabilityModel.prototype.load=function(){var a=function(a){this.rowIndexMap={};for(var c=0;c<a.length;c++)this.rowIndexMap[a[c]]=c}.bind(this),b=function(a){termSaliencyList=[];tempList=[];for(var b in a)tempList.push([b,a[b]]);tempList.sort(function(a,b){return b[1]-a[1]});for(a=0;a<tempList.length;a++)this.termSaliencyList.push(tempList[a][0])}.bind(this),g=function(c,f,d){this.termRankMap=f.termRankMap;this.termOrderMap=f.termOrderMap;this.termDistinctivenessMap=f.termDistinctivenessMap;
a(this.parentModel.get("termIndex"));b(f.termSaliencyMap);this.initTopTermLists();this.defaultSelection();this.filter(!1);c=this.stateModel.get("selectedTopics");for(var k in c)claimColor(c[k]),this.selectTopic({topic:k,color:c[k]});this.trigger("loaded:filtered")}.bind(this),h=function(a,b,d){}.bind(this);this.fetch({add:!1,success:g,error:h})};
FilteredTermTopicProbabilityModel.prototype.initTopTermLists=function(){var a=this.parentModel.get("termIndex"),b=this.parentModel.get("topicIndex"),g=generateColumnFirst(this.parentModel.get("matrix"));this.topTermLists={};for(var h=0;h<b.length;h++){this.topTermLists[h]=[];for(var c=g[h],f=Array(a.length),d=0;d<a.length;d++)f[d]=d;f.sort(function(a,b){return c[a]<c[b]?1:c[a]>c[b]?-1:0});for(d=0;20>d&&f[d]>THRESHHOLD;)this.topTermLists[h].push(a[f[d]]),d++}};
FilteredTermTopicProbabilityModel.prototype.update=function(a){this.filter(!1)};FilteredTermTopicProbabilityModel.prototype.addTopTerms=function(){for(var a in this.selectedTopics)this.selectedTopics[a]&&(this.visibleTopTerms[a]=this.topTermLists[a])};
FilteredTermTopicProbabilityModel.prototype.filter=function(a){var b=this.parentModel.get("matrix"),g=this.parentModel.get("termIndex"),h=this.parentModel.get("topicIndex"),c=this.stateModel.get("visibleTerms").slice(0);this.stateModel.get("addTopTwenty")?this.addTopTerms():this.visibleTopTerms={};for(var f=this.stateModel.get("numAffinityTerms"),d=this.stateModel.get("numSalientTerms"),k=[],m=[],q=function(a){if(0<=c.indexOf(a))return k.push(a),!0;if(this.termRankMap[a]<f||0<=this.termSaliencyList.indexOf(a)&&
this.termSaliencyList.indexOf(a)<d)return!0;for(var b in this.visibleTopTerms)if(0<=this.visibleTopTerms[b].indexOf(a))return!0;return!1}.bind(this),n=this.stateModel.get("sortType"),l=0;l<g.length;l++){var e=g[l];if(q(e))if(""===n)m.push([e,this.termOrderMap[e]]);else if("desc"===n){var p=this.stateModel.get("doubleClickTopic");m.push([e,1/(b[this.rowIndexMap[e]][p]*this.termDistinctivenessMap[e])])}else"asc"===n&&(p=this.stateModel.get("doubleClickTopic"),m.push([e,b[this.rowIndexMap[e]][p]*this.termDistinctivenessMap[e]]))}for(l=
0;l<k.length;l++)c.splice(c.indexOf(k[l]),1);m.sort(function(a,b){return a[1]-b[1]});matrix=[];termIndex=[];for(g=0;g<m.length;g++)e=m[g][0],termIndex.push(e),matrix.push(b[this.rowIndexMap[e]]);this.set("topicIndex",h,{silent:a});this.set("termIndex",termIndex,{silent:a});this.set("matrix",matrix,{silent:a});this.set("sparseMatrix",generateSparseMatrix.bind(this)(),{silent:a});this.stateModel.setFoundTerms(k,a);this.stateModel.setUnfoundTerms(c,a);this.stateModel.set("totalTerms",termIndex.length)};
FilteredTermTopicProbabilityModel.prototype.selectTopic=function(a){var b=a.topic;a=a.color;this.parentModel.get("topicIndex");null!==b&&(a===DEFAULT?this.selectedTopics[b]&&(delete this.visibleTopTerms[b],this.selectedTopics[b]=!1,this.filter(!1)):!1===this.selectedTopics[b]&&(this.selectedTopics[b]=!0,this.filter(!1)))};
