var MATRIX_CONTAINER_PADDING={left_separation:8,top_separation:5,left:110,right:20,top:60,bottom:60,fullWidth:function(a){return this.left+this.right+MATRIX_ENCODING_PARAMETERS.packing()*a},fullHeight:function(a,b){return this.top+this.bottom+MATRIX_ENCODING_PARAMETERS.packing()*b}},MATRIX_ENCODING_PARAMETERS={NUM_TOPICS:0,NUM_TERMS:0,MATRIX:null,setNumTopics:function(a){this.NUM_TOPICS=a},setNumTerms:function(a){this.NUM_TERMS=a},setMatrix:function(a){this.MATRIX=a},DENSE_NUM_TOPICS:50,LOOSE_NUM_TOPICS:20,
DENSE_PACKING:12,LOOSE_PACKING:18,packing:function(){return 12},TARGET_PIXEL_DENSITY:.2,radius:function(a,b,d){var e=0,c;for(c in a)e+=a[c].value*Math.PI;e=b*d*this.packing()*this.packing()*this.TARGET_PIXEL_DENSITY/e;b=Math.sqrt(e);e=0;for(c in a)e+=b*b*a[c].value*Math.PI;return b}},TermTopicMatrixView=Backbone.View.extend({initialize:function(){this.topLabelLayer=this.leftLabelLayer=this.matrixLayer=this.yGridlineLayer=this.xGridlineLayer=this.svg=this.rs=this.ys=this.xs=this.parentModel=null;this.selectedTopics=
[];this.normalColor="normal";this.receivedColors=this.highlightedTopic=this.highlightedTerm=null}});TermTopicMatrixView.prototype.initModel=function(a){this.parentModel=a};TermTopicMatrixView.prototype.receiveSelectedTopics=function(a){this.receivedColors=a};TermTopicMatrixView.prototype.load=function(){this.renderInit();this.renderUpdate();for(var a in this.selectedTopics)this.selectTopic(a,this.selectedTopics[a])};
TermTopicMatrixView.prototype.defaultSelection=function(){for(var a=this.parentModel.get("topicIndex"),b=0;b<a.length;b++)this.selectedTopics[b]=this.normalColor,null!==this.receivedColors&&void 0!==this.receivedColors[b]&&(this.selectedTopics[b]=this.receivedColors[b])};
TermTopicMatrixView.prototype.renderInit=function(){var a=this.parentModel.get("sparseMatrix"),b=this.parentModel.get("termIndex"),d=this.parentModel.get("topicIndex");this.defaultSelection();this.xs=d3.scale.linear();this.ys=d3.scale.linear();this.rs=d3.scale.sqrt().domain([0,1]).range([0,MATRIX_ENCODING_PARAMETERS.radius(a,d.length,b.length)]);this.svg=d3.select(this.el).append("svg:svg");this.initMatrixView();this.initTopLabelView();this.initLeftLabelView()};
TermTopicMatrixView.prototype.renderUpdate=function(){var a=this.parentModel.get("termIndex"),b=this.parentModel.get("topicIndex");this.xs.domain([0,b.length]).range([MATRIX_CONTAINER_PADDING.left,MATRIX_CONTAINER_PADDING.left+b.length*MATRIX_ENCODING_PARAMETERS.packing()]);this.ys.domain([0,a.length]).range([MATRIX_CONTAINER_PADDING.top,MATRIX_CONTAINER_PADDING.top+a.length*MATRIX_ENCODING_PARAMETERS.packing()]);this.svg.style("width",MATRIX_CONTAINER_PADDING.fullWidth(b.length)+"px").style("height",
MATRIX_CONTAINER_PADDING.fullHeight(b.length,a.length)+"px");this.updateMatrixView();this.updateTopLabelView();this.updateLeftLabelView()};TermTopicMatrixView.prototype.initMatrixView=function(){this.xGridlineLayer=this.svg.append("svg:g").attr("class","xGridlineLayer");this.yGridlineLayer=this.svg.append("svg:g").attr("class","yGridlineLayer");this.matrixLayer=this.svg.append("svg:g").attr("class","matrixLayer")};
TermTopicMatrixView.prototype.updateMatrixView=function(){var a=this.parentModel.get("sparseMatrix"),b=this.parentModel.get("termIndex"),d=this.parentModel.get("topicIndex");this.matrixLayer.selectAll("circle").data(a).exit().remove();this.matrixLayer.selectAll("circle").data(a).enter().append("svg:circle").on("mouseout",function(){this.trigger("mouseout:term","");this.trigger("mouseout:topic",null)}.bind(this));this.matrixLayer.selectAll("circle").data(a).attr("class",function(a){return["matrixElement",
this.selectedTopics[a.topicIndex],getTopicClassTag(a.topicName),getTermClassTag(a.term)].join(" ")}.bind(this)).on("mouseover",function(a){this.trigger("mouseover:term",a.term);this.trigger("mouseover:topic",a.topicIndex)}.bind(this)).on("click",function(a){this.trigger("click:topic",a.topicIndex)}.bind(this)).attr("cx",function(a){return this.xs(a.topicIndex+.5)}.bind(this)).attr("cy",function(a){return this.ys(a.termIndex+.5)}.bind(this)).attr("r",function(a){return this.rs(a.value)}.bind(this));
this.xGridlineLayer.selectAll("line").data(b).exit().remove();this.xGridlineLayer.selectAll("line").data(b).enter().append("svg:line").attr("x1",this.xs(.5));this.xGridlineLayer.selectAll("line").data(b).attr("class",function(a){return["verticalLine",this.normalColor,getTermClassTag(a)].join(" ")}.bind(this)).attr("x2",this.xs(d.length-.5)).attr("y1",function(a,b){return this.ys(b+.5)}.bind(this)).attr("y2",function(a,b){return this.ys(b+.5)}.bind(this));this.yGridlineLayer.selectAll("line").data(d).exit().remove();
this.yGridlineLayer.selectAll("line").data(d).enter().append("svg:line").attr("y1",this.ys(.5));this.yGridlineLayer.selectAll("line").data(d).attr("class",function(a,b){return["verticalLine",this.selectedTopics[b],getTopicClassTag(a)].join(" ")}.bind(this)).attr("x1",function(a,b){return this.xs(b+.5)}.bind(this)).attr("x2",function(a,b){return this.xs(b+.5)}.bind(this)).attr("y2",this.ys(b.length-.5))};
TermTopicMatrixView.prototype.initTopLabelView=function(){this.topLabelLayer=this.svg.append("svg:g").attr("class","topLabelLayer")};
TermTopicMatrixView.prototype.updateTopLabelView=function(){var a=this.parentModel.get("topicIndex"),b=null;this.topLabelLayer.selectAll("text").data(a).exit().remove();this.topLabelLayer.selectAll("text").data(a).enter().append("svg:text").on("mouseout",function(){this.trigger("mouseout:topic",null)}.bind(this)).attr("y",3);this.topLabelLayer.selectAll("text").data(a).attr("class",function(a,b){return["topLabel",this.selectedTopics[b],getTopicClassTag(a)].join(" ")}.bind(this)).on("mouseover",function(a,
b){this.trigger("mouseover:topic",b)}.bind(this)).attr("transform",function(a,b){return"translate("+this.xs(b+.5)+","+(this.ys(0)-MATRIX_CONTAINER_PADDING.top_separation)+") rotate(270)"}.bind(this)).text(function(a){return a}).on("click",function(a,c){b=setTimeout(function(){d(a,c)},200)}).on("dblclick",function(a,c){clearTimeout(b);b=null;this.trigger("doubleClick:topic",c)}.bind(this));var d=function(a,c){null!==b&&this.trigger("click:topic",c)}.bind(this)};
TermTopicMatrixView.prototype.initLeftLabelView=function(){this.leftLabelLayer=this.svg.append("svg:g").attr("class","leftLabelLayer")};
TermTopicMatrixView.prototype.updateLeftLabelView=function(){var a=this.parentModel.get("termIndex");this.leftLabelLayer.selectAll("text").data(a).exit().remove();this.leftLabelLayer.selectAll("text").data(a).enter().append("svg:text").on("mouseout",function(){this.trigger("mouseout:term","")}.bind(this)).attr("y",3);this.leftLabelLayer.selectAll("text").data(a).attr("class",function(a){return["leftLabel",this.normalColor,getTermClassTag(a)].join(" ")}.bind(this)).on("mouseover",function(a){this.trigger("mouseover:term",
a)}.bind(this)).attr("transform",function(a,d){return"translate("+(this.xs(0)-MATRIX_CONTAINER_PADDING.left_separation)+","+this.ys(d+.5)+")"}.bind(this)).text(function(a){return a})};TermTopicMatrixView.prototype.update=function(){this.renderUpdate()};TermTopicMatrixView.prototype.onSelectionTermChanged=function(a,b){""===b?this.unhighlight(!0,!1):this.highlight(b,null)};TermTopicMatrixView.prototype.onSelectionTopicChanged=function(a,b){null===b?this.unhighlight(!1,!0):this.highlight(null,b)};
TermTopicMatrixView.prototype.highlight=function(a,b){null!==a&&(this.highlightedTerm=a,this.svg.selectAll("."+getTermClassTag(a)).classed(HIGHLIGHT,!0));if(null!==b){a=this.parentModel.get("topicIndex");var d=this.parentModel.get("termIndex"),e=this.parentModel.get("matrix");this.highlightedTopic=b;this.svg.selectAll("."+getTopicClassTag(a[b])).classed(HIGHLIGHT,!0);for(var c=0;c<d.length;c++)a=d[c],e[c][b]>THRESHHOLD&&this.leftLabelLayer.selectAll("."+getTermClassTag(a)).classed(HIGHLIGHT,!0)}};
TermTopicMatrixView.prototype.unhighlight=function(a,b){a&&null!==this.highlightedTerm&&(this.svg.selectAll("."+getTermClassTag(this.highlightedTerm)).classed(HIGHLIGHT,!1),this.highlightedTerm=null);if(b&&null!==this.hightlightedTopic){a=this.parentModel.get("topicIndex");b=this.parentModel.get("termIndex");var d=this.parentModel.get("matrix"),e=this.highlightedTopic;this.svg.selectAll("."+getTopicClassTag(a[e])).classed(HIGHLIGHT,!1);for(var c=0;c<b.length;c++)a=b[c],d[c][e]>THRESHHOLD&&this.leftLabelLayer.selectAll("."+
getTermClassTag(a)).classed(HIGHLIGHT,!1);this.highlightedTopic=null}};TermTopicMatrixView.prototype.clickTopic=function(a){this.selectTopic(a.topic,a.color)};TermTopicMatrixView.prototype.selectTopic=function(a,b){var d=this.parentModel.get("topicIndex");if(null!==a){b===DEFAULT&&(b=this.normalColor);var e=this.selectedTopics[a];this.svg.selectAll("."+getTopicClassTag(d[a])).classed(e,!1).classed(b,!0);this.selectedTopics[a]=b}};
