var TERMFREQ_TEXT_DEFAULT={FILL_COLOR:"#808080",STROKE_OPACITY:0,FILL_OPACITY:1},TERMFREQ_BAR_DEFAULT={STROKE_COLOR:"#808080",STROKE_WIDTH:5,STROKE_OPACITY:.4},HISTOGRAM_ENCODING_PARAMETERS={NUM_TOPICS:0,setNumTopics:function(a){this.NUM_TOPICS=a},DENSE_NUM_TOPICS:50,LOOSE_NUM_TOPICS:20,DENSE_PACKING:12,LOOSE_PACKING:18,packing:function(){return 12}},HISTORGRAM_CONTAINER_PADDING={left_separation:10,top:60,left:130,right:20,bottom:60,width:150,fullWidth:function(){return this.left+this.right+this.width},
fullHeight:function(a,b){return this.top+this.bottom+HISTOGRAM_ENCODING_PARAMETERS.packing()*b}},TermFrequencyView=Backbone.View.extend({initialize:function(){this.highlightedTopic=this.highlightedTerm=this.svgTermHighlightLayer=this.svgTopicalBarLayer=this.overlayLineLayer=this.overlayLayer=this.svgTermBarLayer=this.svgTermLabelLayer=this.svg=this.line_length=this.ys=this.parentModel=null;this.selectedTopics=[];this.colorClassPrefix="HIST";this.normalColor="normal";this.totalOffsets=[];this.prevHighlightColor=
this.normalColor;this.useOffset=!1}});TermFrequencyView.prototype.initModel=function(a,b){this.parentModel=a};TermFrequencyView.prototype.load=function(){this.renderInit();this.renderUpdate()};TermFrequencyView.prototype.update=function(){this.renderUpdate()};
TermFrequencyView.prototype.prepareStackedBars=function(){var a=this.parentModel.get("topicalFreqMatrix");if(0===a.length)return[];a=a.map(function(a){return a.map(function(a,e){return{x:e,y:a}})});a=d3.layout.stack()(a);this.totalOffsets=[];if(0<a.length)for(var b=0;b<a[0].length;b++){for(var d=0,c=0;c<a.length;c++)d+=a[c][b].y;this.totalOffsets[b]=d}return a};
TermFrequencyView.prototype.renderInit=function(){var a=this.parentModel.get("termIndex"),b=this.parentModel.get("totalTermFreqs");this.ys=d3.scale.linear();for(var d=0,c=0;c<a.length;c++)b[a[c]]>d&&(d=b[a[c]]);this.line_length=d3.scale.linear().domain([0,d]).range([0,HISTORGRAM_CONTAINER_PADDING.width]);this.svg=d3.select(this.el).append("svg:svg").style("cursor","default").style("width",HISTORGRAM_CONTAINER_PADDING.fullWidth()+"px");this.svgTermLabelLayer=this.svg.append("svg:g").attr("class","termLabelLayer").attr("transform",
"translate("+HISTORGRAM_CONTAINER_PADDING.left+","+HISTORGRAM_CONTAINER_PADDING.top+")");this.svgTermBarLayer=this.svg.append("svg:g").attr("class","termBarLayer").attr("transform","translate("+HISTORGRAM_CONTAINER_PADDING.left+","+HISTORGRAM_CONTAINER_PADDING.top+")");this.overlayLayer=this.svg.append("svg:g").attr("class","overlayLayer").attr("transform","translate("+HISTORGRAM_CONTAINER_PADDING.left+","+HISTORGRAM_CONTAINER_PADDING.top+")");this.svgTopicalBarLayer=this.svg.append("svg:g").attr("class",
"topicalBarLayer").attr("transform","translate("+HISTORGRAM_CONTAINER_PADDING.left+","+HISTORGRAM_CONTAINER_PADDING.top+")");this.svgTermHighlightLayer=this.svg.append("svg:g").attr("class","termHighlightLayer").attr("transform","translate("+HISTORGRAM_CONTAINER_PADDING.left+","+HISTORGRAM_CONTAINER_PADDING.top+")")};
TermFrequencyView.prototype.renderUpdate=function(){var a=this.parentModel.get("termIndex"),b=this.parentModel.get("totalTermFreqs");this.svg.style("height",HISTORGRAM_CONTAINER_PADDING.fullHeight(HISTOGRAM_ENCODING_PARAMETERS.NUM_TOPICS,a.length)+"px");this.ys.domain([0,a.length]).range([0,a.length*HISTOGRAM_ENCODING_PARAMETERS.packing()]);this.svgTermLabelLayer.selectAll("text").data(a).exit().remove();this.svgTermLabelLayer.selectAll("text").data(a).enter().append("svg:text").on("mouseout",function(){this.trigger("mouseout:term",
"")}.bind(this)).attr("x",-HISTORGRAM_CONTAINER_PADDING.left_separation).attr("y",3);this.svgTermLabelLayer.selectAll("text").data(a).attr("class",function(a){return["termLabel HISTnormal",getTermClassTag(a)].join(" ")}).attr("transform",function(a,b){return"translate(0,"+this.ys(b+.5)+")"}.bind(this)).on("mouseover",function(a){this.trigger("mouseover:term",a)}.bind(this)).text(function(a){return a});this.svgTermBarLayer.selectAll("line").data(a).exit().remove();this.svgTermBarLayer.selectAll("line").data(a).enter().append("svg:line").on("mouseout",
function(){this.trigger("mouseout:term","")}.bind(this)).attr("y1",0).attr("y2",0).attr("x1",this.line_length(0));this.svgTermBarLayer.selectAll("line").data(a).attr("transform",function(a,b){return"translate(0,"+this.ys(b+.5)+")"}.bind(this)).attr("class",function(a,b){return["termFreqBar",getTermClassTag(a)].join(" ")}).on("mouseover",function(a){this.trigger("mouseover:term",a)}.bind(this)).attr("x2",function(a){return this.line_length(b[a])}.bind(this));var d=this.prepareStackedBars(),c=this.parentModel.get("colorList");
this.overlayLayer.selectAll("g").data(d).exit().remove();this.overlayLayer.selectAll("g").data(d).enter().append("svg:g");this.gLayer=this.overlayLayer.selectAll("g").data(d).attr("class",function(a,b){return["overlayGroup",this.colorClassPrefix+c[b]].join(" ")}.bind(this));this.gLayer.selectAll("line").data(function(a){return a}).exit().remove();this.gLayer.selectAll("line").data(function(a,b){return a}).enter().append("svg:line").attr("y1",0).attr("y2",0);this.gLayer.selectAll("line").data(function(a,
b){return a}).attr("class",function(b,c){return["line",getTermClassTag(a[c])].join(" ")}).attr("transform",function(a,b){return"translate(0,"+this.ys(b+.5)+")"}.bind(this)).attr("x1",function(a){return this.line_length(a.y0)}.bind(this)).attr("x2",function(a){return this.line_length(a.y0)+this.line_length(a.y)}.bind(this));this.svgTopicalBarLayer.selectAll("line").data(a).exit().remove();this.svgTopicalBarLayer.selectAll("line").data(a).enter().append("svg:line").on("mouseout",function(){this.trigger("mouseout:term",
"")}.bind(this)).attr("y1",0).attr("y2",0).attr("x1",this.line_length(0)).attr("x2",this.line_length(0));this.svgTopicalBarLayer.selectAll("line").data(a).attr("transform",function(a,b){return"translate(0,"+this.ys(b+.5)+")"}.bind(this)).attr("class",function(a,b){return["topicalFreqBar",getTermClassTag(a)].join(" ")}).on("mouseover",function(a){this.trigger("mouseover:term",a)}.bind(this));this.svgTermHighlightLayer.selectAll("line").data(a).exit().remove();this.svgTermHighlightLayer.selectAll("line").data(a).enter().append("svg:line").on("mouseout",
function(){this.trigger("mouseout:term","")}.bind(this)).attr("y1",0).attr("y2",0).attr("x1",this.line_length(0)).style("fill","none");this.svgTermHighlightLayer.selectAll("line").data(a).attr("transform",function(a,b){return"translate(0,"+this.ys(b+.5)+")"}.bind(this)).attr("class",function(a,b){return["termHighlightBar",getTermClassTag(a)].join(" ")}).on("mouseover",function(a){this.trigger("mouseover:term",a)}.bind(this)).attr("x2",function(a){return this.line_length(b[a])}.bind(this))};
TermFrequencyView.prototype.onHighlightTopicChanged=function(a,b){null===b?this.unhighlight(!1,!0):this.highlight(null,b)};TermFrequencyView.prototype.onHighlightTermChanged=function(a,b){""===b?this.unhighlight(!0,!1):this.highlight(b,null)};
TermFrequencyView.prototype.unhighlight=function(a,b){a&&(a=this.highlightedTerm,this.highlightedTerm=null,this.svgTermLabelLayer.selectAll("."+getTermClassTag(a)).classed(this.colorClassPrefix+HIGHLIGHT,!1),this.svgTermHighlightLayer.selectAll("."+getTermClassTag(a)).classed(this.colorClassPrefix+HIGHLIGHT,!1));if(b){b=this.highlightedTopic;var d=this.parentModel.get("termIndex");b=this.parentModel.getTopicalsForTopic(b);this.highlightedTopic=null;for(var c=0;c<d.length;c++)a=d[c],b[c]>THRESHHOLD&&
(this.svgTermLabelLayer.selectAll("."+getTermClassTag(a)).classed(this.colorClassPrefix+HIGHLIGHT,!1),this.useOffset&&this.svgTopicalBarLayer.selectAll("."+getTermClassTag(a)).classed(this.colorClassPrefix+HIGHLIGHT,!1).attr("x2",this.line_length(0)).attr("x1",this.line_length(0)));var e=this.parentModel.get("colorList");this.gLayer=this.overlayLayer.selectAll("g").attr("class",function(a,b){return["overlayGroup",this.colorClassPrefix+e[b]].join(" ")}.bind(this));this.prevHighlightColor=this.normalColor;
this.useOffset=!1}};
TermFrequencyView.prototype.highlight=function(a,b){if(null!==a)this.highlightedTerm=a,this.svgTermLabelLayer.selectAll("."+getTermClassTag(a)).classed(this.colorClassPrefix+HIGHLIGHT,!0),this.svgTermHighlightLayer.selectAll("."+getTermClassTag(a)).classed(this.colorClassPrefix+HIGHLIGHT,!0);else if(null!==b){var d=this.parentModel.get("termIndex"),c=this.parentModel.getTopicalsForTopic(b);this.highlightedTopic=b;this.prepareStackedBars();a=this.parentModel.get("selectedTopics");var e=this.parentModel.get("colorList").slice();
null!==a[b]?(this.prevHighlightColor=a[b],e[e.indexOf(a[b])]=HIGHLIGHT,this.gLayer=this.overlayLayer.selectAll("g").attr("class",function(a,b){return["overlayGroup",this.colorClassPrefix+e[b]].join(" ")}.bind(this))):this.useOffset=!0;for(b=0;b<d.length;b++)if(a=d[b],c[b]>THRESHHOLD&&(this.svgTermLabelLayer.selectAll("."+getTermClassTag(a)).classed(this.colorClassPrefix+HIGHLIGHT,!0),this.useOffset)){var f=0;0<this.totalOffsets.length&&(f=this.totalOffsets[b]);this.svgTopicalBarLayer.selectAll("."+
getTermClassTag(a)).classed(this.colorClassPrefix+HIGHLIGHT,!0).attr("x2",this.line_length(f+c[b])).attr("x1",this.line_length(f))}}};
